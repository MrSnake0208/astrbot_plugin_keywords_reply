# ⌨️ 关键词回复插件

![License](https://img.shields.io/badge/license-AGPL--3.0-green?style=flat-square)
![Python](https://img.shields.io/badge/python-3.10+-blue?style=flat-square&logo=python&logoColor=white)
![AstrBot](https://img.shields.io/badge/framework-AstrBot-ff6b6b?style=flat-square)

一款为 [AstrBot](https://github.com/AstrBotDevs/AstrBot) 设计的关键词回复插件，支持指令触发、自动监听、正则表达式、图文回复以及精细化的群聊黑白名单控制。

---

## ✨ 功能特性

* **🚀 双模式触发**: 支持“指令触发”（如 `/关键词`）和“自动监听”（消息包含关键词即回复）两种模式
* **📝 图文回复**: 支持文字与图片的组合回复，支持自动下载并缓存消息中的图片
* **🔍 正则表达式**: 监听模式支持正则表达式匹配，并内置安全检查防止 ReDoS 攻击
* **🛡️ 黑白名单控制**: 每个关键词可独立设置在哪些群聊启用或禁用，支持全局配置
* **💬 引用回复**: 可选在回复时引用触发者的原始消息，让回复更有针对性
* **🕒 自动撤回**: 支持设置回复消息后的自动撤回延迟，适用于保持群聊整洁
* **🕒 检测冷却**: 支持设置检测词触发冷却时间，防止短时间内高频触发导致刷屏
* **📊 灵活管理**: 支持为一个关键词添加多个回复词条，触发时随机选择；支持通过序号或内容快速操作

---

## 📖 使用指南

⚠️ **所有管理指令仅限 Bot 管理员及白名单用户使用**

### 1️⃣ 关键词管理 (指令触发型)

直接输入关键词（需带指令前缀，如 `/关键词`）即可触发回复。

| 命令               | 格式                                   | 说明                                                    |
| :----------------- | :------------------------------------- | :------------------------------------------------------ |
| **添加**     | `/添加关键词 <关键词> <回复内容>`    | 添加新关键词，回复内容支持图片                          |
| **编辑**     | `/编辑关键词 <序号/内容> <新关键词>` | 修改关键词触发词                                        |
| **删除**     | `/删除关键词 <序号/内容>`            | 删除整个关键词及其所有回复                              |
| **查看列表** | `/查看关键词列表`                    | 列出所有指令触发型的关键词（别名：`/查看所有关键词`） |
| **详情**     | `/查看关键词 <序号/内容>`            | 查看关键词的详细配置及完整回复内容                      |

### 2️⃣ 检测词管理 (自动监听型)

监听聊天消息，匹配成功后自动回复。

| 命令               | 格式                                     | 说明                                                    |
| :----------------- | :--------------------------------------- | :------------------------------------------------------ |
| **添加**     | `/添加检测词 [-r] <关键词> <回复内容>` | `-r` 参数表示启用正则表达式匹配                       |
| **编辑**     | `/编辑检测词 [-r] <序号> <新关键词>`   | 修改检测词触发词或正则开关                              |
| **删除**     | `/删除检测词 <序号/内容>`              | 删除该检测词                                            |
| **查看列表** | `/查看检测词列表`                      | 列出所有自动监听型的检测词（别名：`/查看所有检测词`） |
| **详情**     | `/查看检测词 <序号/内容>`              | 查看检测词的匹配模式及回复内容                          |

### 3️⃣ 回复词条管理

每个关键词/检测词可以拥有多个回复，系统会随机抽取一个。

* **添加回复**: `/添加[关键词/检测词]回复 <序号/内容> <新回复内容>`
* **查看回复**: `/查看[关键词/检测词]回复 <序号/内容> [回复序号]`
* **编辑回复**: `/编辑[关键词/检测词]回复 <序号/内容> [回复序号] <新回复内容>`
* **删除回复**: `/删除[关键词/检测词]回复 <序号/内容> [回复序号]`

> **注**：当关键词仅有一个回复时，查看、编辑和删除指令中的 `回复序号` 可以省略。

### 4️⃣ 群聊控制 (黑白名单)

> **注**：以下示例以“关键词”为例，对于“检测词”，只需将指令中的 `关键词` 替换为 `检测词` 即可（如 `/启用检测词`）。

| 命令                 | 示例                        | 说明                                 |
| :------------------- | :-------------------------- | :----------------------------------- |
| **指定群启用** | `/启用关键词 1 123456789` | 切换为白名单模式，并添加指定群号     |
| **当前群启用** | `/启用关键词 1`           | 在当前群聊启用该词                   |
| **全局启用**   | `/启用关键词 1 全局`      | 切换为黑名单模式并清空，即全平台生效 |
| **指定群禁用** | `/禁用关键词 1 123456789` | 切换为黑名单模式，并添加指定群号     |
| **当前群禁用** | `/禁用关键词 1`           | 在当前群聊禁用该词                   |
| **全局禁用**   | `/禁用关键词 1 全局`      | 彻底关闭该关键词的触发               |

---

## ⚙️ 配置项

在 AstrBot 后台配置界面进行设置：

| 配置项                       | 类型          | 默认值    | 描述                                                                  |
| :--------------------------- | :------------ | :-------- | :-------------------------------------------------------------------- |
| **`whitelist`**      | `list[str]` | `[]`    | 允许管理插件的用户 ID 列表（非管理员也可用指令）。                    |
| **`words_limit`**    | `int`       | `10`    | 每个触发词允许配置的最大回复词条数量。                                |
| **`case_sensitive`** | `bool`      | `false` | 针对检测词匹配时是否区分大小写。                                      |
| **`quote_reply`**    | `bool`      | `false` | 回复时是否引用触发回复的消息。                                        |
| **`recall_delay`**   | `str`       | `"0 0"` | 自动撤回延迟（秒）。格式：`"关键词延迟 检测词延迟"`。0 表示不撤回。 |
| **`cooldown`**       | `int`       | `0`     | 全局触发冷却时间（秒），0 表示不冷却。   

---

## 📝 更新日志

* **v1.0**
  * 新增检测词冷却时间。

* **v0.1**
  * 实现基础的指令触发与自动检测功能。
  * 支持多回复随机抽取与图文组合。
  * 支持正则表达式匹配及安全校验。
  * 完善的群聊黑白名单管理系统。

---

## ❤️ 支持

* [AstrBot 帮助文档](https://astrbot.app)

* 如果您在使用中遇到问题，欢迎提交 [Issue](https://github.com/Foolllll-J/astrbot_plugin_keywords_reply/issues)。

---

## 🙏 致谢

* 部分代码参考了以下优秀项目，在此表示诚挚感谢：
  * [astrbot_plugin_wbank](https://github.com/Zhalslar/astrbot_plugin_wbank)
  * [astrbot_plugin_keywordsreply](https://github.com/Origin173/astrbot_plugin_keywordsreply)

